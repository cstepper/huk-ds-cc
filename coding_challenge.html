<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Christoph Stepper">
<meta name="dcterms.date" content="2023-06-02">

<title>Motor third-part liability</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="coding_challenge_files/libs/clipboard/clipboard.min.js"></script>
<script src="coding_challenge_files/libs/quarto-html/quarto.js"></script>
<script src="coding_challenge_files/libs/quarto-html/popper.min.js"></script>
<script src="coding_challenge_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="coding_challenge_files/libs/quarto-html/anchor.min.js"></script>
<link href="coding_challenge_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="coding_challenge_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="coding_challenge_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="coding_challenge_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="coding_challenge_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="coding_challenge_files/libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="coding_challenge_files/libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="coding_challenge_files/libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">

<script src="coding_challenge_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="coding_challenge_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#background-and-task" id="toc-background-and-task" class="nav-link active" data-scroll-target="#background-and-task">Background and Task</a></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis">Analysis</a>
  <ul>
  <li><a href="#data-import-and-preparation" id="toc-data-import-and-preparation" class="nav-link" data-scroll-target="#data-import-and-preparation">Data Import and Preparation</a>
  <ul class="collapse">
  <li><a href="#modeling-dataset" id="toc-modeling-dataset" class="nav-link" data-scroll-target="#modeling-dataset">Modeling Dataset</a></li>
  </ul></li>
  <li><a href="#eda" id="toc-eda" class="nav-link" data-scroll-target="#eda">EDA</a>
  <ul class="collapse">
  <li><a href="#response" id="toc-response" class="nav-link" data-scroll-target="#response">Response</a></li>
  <li><a href="#predictors" id="toc-predictors" class="nav-link" data-scroll-target="#predictors">Predictors</a></li>
  </ul></li>
  <li><a href="#modeling" id="toc-modeling" class="nav-link" data-scroll-target="#modeling">Modeling</a>
  <ul class="collapse">
  <li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering">Feature Engineering</a></li>
  <li><a href="#model-training" id="toc-model-training" class="nav-link" data-scroll-target="#model-training">Model Training</a></li>
  <li><a href="#model-building" id="toc-model-building" class="nav-link" data-scroll-target="#model-building">Model building</a></li>
  <li><a href="#model-explanations-variable-importance" id="toc-model-explanations-variable-importance" class="nav-link" data-scroll-target="#model-explanations-variable-importance">Model explanations / Variable importance</a></li>
  <li><a href="#model-selection" id="toc-model-selection" class="nav-link" data-scroll-target="#model-selection">Model selection</a></li>
  <li><a href="#model-optimizations" id="toc-model-optimizations" class="nav-link" data-scroll-target="#model-optimizations">Model optimizations</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#discussion-and-outlook" id="toc-discussion-and-outlook" class="nav-link" data-scroll-target="#discussion-and-outlook">Discussion and Outlook</a></li>
  </ul>
</nav>
</div>
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Motor third-part liability</h1>
<p class="subtitle lead">Modeling expected amount of damage</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Christoph Stepper </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 2, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="background-and-task" class="level2">
<h2 class="anchored" data-anchor-id="background-and-task">Background and Task</h2>
<p>Two datasets <a href="https://www.openml.org/d/41214">freMTPL2freq</a> and <a href="https://www.openml.org/d/41215">freMTPL2sev</a> contain risk features and claims (numbers and amounts) for motor third-part liability policies in France.</p>
<p>The <em>task</em> is to model the <em>expected amount of damage per policy holder and year</em>, using a set of risk features.</p>
</section>
<section id="analysis" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="analysis">Analysis</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load required packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tidymodels_prefer</span>()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># library(DALEX)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># library(agua)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(base<span class="sc">::</span>log10)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(base<span class="sc">::</span><span class="st">`</span><span class="at">||</span><span class="st">`</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">dplyr.summarise.inform =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot2 theme</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># h2o setup</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># agua::h2o_start()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="data-import-and-preparation" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="data-import-and-preparation">Data Import and Preparation</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># just for the convenience of not having to download it on every render</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># files = c(</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   freq = "https://api.openml.org/data/v1/download/20649148/freMTPL2freq.arff",</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   sev = "https://api.openml.org/data/v1/download/20649149/freMTPL2sev.arff"</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># files |&gt; </span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   walk(</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     \(x) {</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#       download.file(</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">#         url = x,</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">#         destfile = fs::path("data", basename(x))</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">#       )</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># risk features</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>freq <span class="ot">=</span> foreign<span class="sc">::</span><span class="fu">read.arff</span>(<span class="st">"data/freMTPL2freq.arff"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(freq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   678013 obs. of  12 variables:
 $ IDpol     : num  1 3 5 10 11 13 15 17 18 21 ...
 $ ClaimNb   : num  1 1 1 1 1 1 1 1 1 1 ...
 $ Exposure  : num  0.1 0.77 0.75 0.09 0.84 0.52 0.45 0.27 0.71 0.15 ...
 $ Area      : Factor w/ 6 levels "A","B","C","D",..: 4 4 2 2 2 5 5 3 3 2 ...
 $ VehPower  : num  5 5 6 7 7 6 6 7 7 7 ...
 $ VehAge    : num  0 0 2 0 0 2 2 0 0 0 ...
 $ DrivAge   : num  55 55 52 46 46 38 38 33 33 41 ...
 $ BonusMalus: num  50 50 50 50 50 50 50 68 68 50 ...
 $ VehBrand  : Factor w/ 11 levels "B1","B10","B11",..: 4 4 4 4 4 4 4 4 4 4 ...
 $ VehGas    : chr  "Regular" "Regular" "Diesel" "Diesel" ...
 $ Density   : num  1217 1217 54 76 76 ...
 $ Region    : Factor w/ 22 levels "R11","R21","R22",..: 18 18 3 15 15 8 8 20 20 12 ...</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># claim amounts</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>sev <span class="ot">=</span> foreign<span class="sc">::</span><span class="fu">read.arff</span>(<span class="st">"data/freMTPL2sev.arff"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(sev)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   26639 obs. of  2 variables:
 $ IDpol      : num  1552 1010996 4024277 4007252 4046424 ...
 $ ClaimAmount: num  995 1128 1851 1204 1204 ...</code></pre>
</div>
</div>
<section id="modeling-dataset" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="modeling-dataset">Modeling Dataset</h4>
<p>By aggregating the individual claim amounts in the <code>sev</code> dataset, we get the total claim amount per <code>IDpol</code>.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>claim <span class="ot">=</span> sev <span class="sc">|&gt;</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(IDpol) <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">ClaimNumber =</span> <span class="fu">n</span>(),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">ClaimAmount =</span> <span class="fu">sum</span>(ClaimAmount)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(claim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     IDpol          ClaimNumber      ClaimAmount     
 Min.   :    139   Min.   : 1.000   Min.   :      1  
 1st Qu.:1082755   1st Qu.: 1.000   1st Qu.:    750  
 Median :2130128   Median : 1.000   Median :   1172  
 Mean   :2262558   Mean   : 1.068   Mean   :   2433  
 3rd Qu.:3178382   3rd Qu.: 1.000   3rd Qu.:   1346  
 Max.   :6113971   Max.   :66.000   Max.   :4075401  </code></pre>
</div>
</div>
<p>We can already see from the summary, that the distribution of total claim amounts is <em>heavily right-skewed</em>.</p>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>p_data <span class="ot">=</span> claim <span class="sc">|&gt;</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ClaimNumber =</span> <span class="fu">ordered</span>(ClaimNumber)) <span class="sc">|&gt;</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ClaimNumber =</span> <span class="fu">fct_lump</span>(ClaimNumber, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">other_level =</span> <span class="st">"&gt;=4"</span>)) </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>p_xlabs <span class="ot">=</span> <span class="fu">paste0</span>(</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">levels</span>(p_data<span class="sc">$</span>ClaimNumber), <span class="st">"</span><span class="sc">\n</span><span class="st">(N="</span>, <span class="fu">table</span>(p_data<span class="sc">$</span>ClaimNumber), <span class="st">")"</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> p_data <span class="sc">|&gt;</span> </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ClaimNumber, <span class="at">y =</span> ClaimAmount)) <span class="sc">+</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">varwidth =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"grey30"</span>) <span class="sc">+</span> </span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>() <span class="sc">+</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> p_xlabs) <span class="sc">+</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"number of claims"</span>, <span class="at">y =</span> <span class="st">"sum of claim amounts"</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/boxplot-claimNumber-claimAmount-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="coding_challenge_files/figure-html/boxplot-claimNumber-claimAmount-1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">Distribution of total claim amounts (on log10-transformed axis), splitted by number of claims.</figcaption>
</figure>
</div>
</div>
</div>
<p>The boxplot shows, that on average the claim amount increases with claim numbers, but has a very large spread.</p>
<p>Additionally, we can see, that even in the 1st group (1 claim), the distribution of claim amounts is heavily skewed.</p>
<p>Next, we add the risk features to the the aggregated claim amounts and compute the average height of claim amounts per exposure time (defined as the response variable: <code>ClaimAmountExposure</code>)</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># join by ID and ClaimNumber (to make sure, that we only have correctly </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># assigned claims in the analysis)</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">=</span> <span class="fu">inner_join</span>(claim, freq, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"IDpol"</span>, <span class="st">"ClaimNumber"</span> <span class="ot">=</span> <span class="st">"ClaimNb"</span>))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># compute response and keep only relevant columns</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">=</span> dat <span class="sc">|&gt;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">ClaimAmountExposure =</span> ClaimAmount <span class="sc">/</span> Exposure,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.after =</span> ClaimNumber</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>ClaimNumber, <span class="sc">-</span>ClaimAmount)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [24,943 × 12] (S3: tbl_df/tbl/data.frame)
 $ IDpol              : num [1:24943] 139 190 414 424 463 606 622 811 830 975 ...
 $ ClaimAmountExposure: num [1:24943] 404 14156 10404 17474 12860 ...
 $ Exposure           : num [1:24943] 0.75 0.14 0.14 0.62 0.31 0.84 0.75 0.76 0.68 0.73 ...
 $ Area               : Factor w/ 6 levels "A","B","C","D",..: 6 2 5 6 1 4 4 5 5 4 ...
 $ VehPower           : num [1:24943] 7 12 4 10 5 10 5 5 4 9 ...
 $ VehAge             : num [1:24943] 1 5 0 0 0 6 0 0 10 0 ...
 $ DrivAge            : num [1:24943] 61 50 36 51 45 54 34 44 24 60 ...
 $ BonusMalus         : num [1:24943] 50 60 85 100 50 50 64 50 105 50 ...
 $ VehBrand           : Factor w/ 11 levels "B1","B10","B11",..: 4 4 4 4 4 4 4 4 1 4 ...
 $ VehGas             : chr [1:24943] "Regular" "Diesel" "Regular" "Regular" ...
 $ Density            : num [1:24943] 27000 56 4792 27000 12 ...
 $ Region             : Factor w/ 22 levels "R11","R21","R22",..: 1 6 1 1 16 21 8 21 1 21 ...</code></pre>
</div>
</div>
</section>
</section>
<section id="eda" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="eda">EDA</h3>
<section id="response" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="response">Response</h4>
<p>First, focus on the <em>claim amount per exposure</em>, that we want to predict.</p>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># density plot</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>dens <span class="ot">=</span> <span class="fu">density</span>(<span class="fu">log10</span>(dat<span class="sc">$</span>ClaimAmountExposure))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>pks <span class="ot">=</span> pracma<span class="sc">::</span><span class="fu">findpeaks</span>(dens<span class="sc">$</span>y, <span class="at">npeaks =</span> <span class="dv">4</span>, <span class="at">sortstr =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>pks <span class="ot">=</span> <span class="dv">10</span><span class="sc">^</span>(dens<span class="sc">$</span>x[pks[, <span class="dv">2</span>]])</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> dat <span class="sc">|&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(ClaimAmountExposure &lt; 5000) |&gt;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ClaimAmountExposure)) <span class="sc">+</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> pks, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"grey30"</span>) <span class="sc">+</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">fill =</span> <span class="st">"grey70"</span>, <span class="at">alpha =</span> .<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(<span class="at">labels =</span> scales<span class="sc">::</span>comma)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ecdf in desc log-log</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>ecdf_cae <span class="ot">=</span> <span class="fu">ecdf</span>(dat<span class="sc">$</span>ClaimAmountExposure)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">=</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(ClaimAmountExposure) <span class="sc">|&gt;</span> </span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ecdf =</span> <span class="fu">rev</span>(<span class="fu">ecdf_cae</span>(ClaimAmountExposure))) <span class="sc">|&gt;</span> </span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ClaimAmountExposure, <span class="at">y =</span> ecdf)) <span class="sc">+</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">color =</span> <span class="st">"grey30"</span>) <span class="sc">+</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(<span class="at">labels =</span> scales<span class="sc">::</span>comma) <span class="sc">+</span> </span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>() <span class="sc">+</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"relative frequency"</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">/</span> p3 <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"a"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/eda-claim-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="coding_challenge_files/figure-html/eda-claim-1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">Claim amounts per exposure (on log10-transformed axis). (a) density plot. (b) descending ecdf in log-log.</figcaption>
</figure>
</div>
</div>
</div>
<p>The two plots describing the distribution of the response values put on a log10-transformed axis show the following:</p>
<ol type="1">
<li>Generally, the log-transformed data shows a bell-shaped distribution, indicating that our data are following a lognormal distribution.</li>
<li>There is a strong emphasis at values of ~ 1200; the narrow and peaked distribution indicates an underdispersion in the data.</li>
<li>There are some extra peaks in the distribution. This might be due to many claim amounts with a fixed payment (<em>maybe we should follow a non-parametric</em> modeling approach)</li>
<li>The descending ECDF in log-log-scales shows that the distribution is not a power law, as we are not following a straight line. Additionally, it shows the heavily tailedness shape of the distribution at the right side.</li>
</ol>
<p>Keeping this in mind, we argue for applying a <em>log-transformation</em> to the outcome for modeling.</p>
<p>(advantages: less influence of errors in predicting very high values, stabilized variance; disadvantages: difficult interpretation of model coefficients and performance metrics).</p>
<p>The next figure shows a <em>q-q-plot</em> of the transformed data, indicating that we now have a normally distributed response variable, with a standard deviation somewhat &lt; 1.</p>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>p_dat <span class="ot">=</span> dat <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">ClaimAmountExposure =</span> <span class="fu">log10</span>(ClaimAmountExposure))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>params <span class="ot">=</span> <span class="fu">as.list</span>(</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  MASS<span class="sc">::</span><span class="fu">fitdistr</span>(p_dat<span class="sc">$</span>ClaimAmountExposure, <span class="at">densfun =</span> <span class="st">"normal"</span>)<span class="sc">$</span>estimate</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>p_dat <span class="sc">|&gt;</span> </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> ClaimAmountExposure)) <span class="sc">+</span> </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq</span>(<span class="at">distribution =</span> stats<span class="sc">::</span>qnorm, <span class="at">dparams =</span> params, <span class="at">color =</span> <span class="st">"grey30"</span>) <span class="sc">+</span> </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/eda-log-claim-qq-plot-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="coding_challenge_files/figure-html/eda-log-claim-qq-plot-1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">Q-Q-Plot of log-transformed response variable.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="predictors" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="predictors">Predictors</h4>
<p>Next, let’s have a look at the different predictors.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define predictors</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>predictors <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">categorical =</span> <span class="fu">c</span>(<span class="st">"Region"</span>, <span class="st">"VehBrand"</span>, <span class="st">"VehGas"</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">ordinal =</span> <span class="fu">c</span>(<span class="st">"Area"</span>, <span class="st">"VehPower"</span>),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">numeric =</span> <span class="fu">c</span>(<span class="st">"BonusMalus"</span>, <span class="st">"Density"</span>, <span class="st">"DrivAge"</span>, <span class="st">"VehAge"</span>),</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">extra =</span> <span class="st">"Exposure"</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure that all features are encoded correctly and re-level if required</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">=</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(predictors<span class="sc">$</span>categorical, factor),</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(predictors<span class="sc">$</span>ordinal, ordered),</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(predictors<span class="sc">$</span>numeric, as.integer)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(predictors<span class="sc">$</span>categorical)) <span class="sc">|&gt;</span> </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$Region
 R11  R21  R22  R23  R24  R25  R26  R31  R41  R42  R43  R52  R53  R54  R72  R73 
2392   70  302  209 6262  429  328  872  452   83   36 1498 1793  765  985  350 
 R74  R82  R83  R91  R93  R94 
 184 4002  135  934 2753  109 

$VehBrand
  B1  B10  B11  B12  B13  B14   B2   B3   B4   B5   B6 
6509  732  626 3826  511  127 6486 2304 1053 1580 1189 

$VehGas
 Diesel Regular 
  12700   12243 </code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># re-level VehBrand</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">=</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">VehBrand =</span> <span class="fu">fct_relevel</span>(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>      VehBrand, </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>      \(x) <span class="fu">paste0</span>(<span class="st">"B"</span>, <span class="fu">sort</span>(<span class="fu">as.integer</span>(<span class="fu">str_remove</span>(x, <span class="st">"B"</span>))))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="distributions" class="level5 page-columns page-full">
<h5 class="anchored" data-anchor-id="distributions">Distributions</h5>
<p>Let’s see how the predictors are distributed and if we should apply some transformations.</p>
<section id="numeric-predictors" class="level6 page-columns page-full">
<h6 class="anchored" data-anchor-id="numeric-predictors">Numeric predictors</h6>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>preds_numeric <span class="ot">=</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(predictors<span class="sc">$</span>numeric), Exposure) </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># histograms</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>preds_histogram <span class="ot">=</span> preds_numeric <span class="sc">|&gt;</span> </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> 30L, <span class="at">fill =</span> <span class="st">"grey30"</span>) <span class="sc">+</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>preds_histogram</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/hist-predictors-numeric-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="coding_challenge_files/figure-html/hist-predictors-numeric-1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">Histograms of the numeric predictor variables.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># qq-plots</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>preds_qq <span class="ot">=</span> preds_numeric <span class="sc">|&gt;</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> value)) <span class="sc">+</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq</span>(<span class="at">fill =</span> <span class="st">"grey40"</span>, <span class="at">alpha =</span> .<span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq_line</span>() <span class="sc">+</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>preds_qq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/qq-predictors-numeric-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="coding_challenge_files/figure-html/qq-predictors-numeric-1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">Q-Q-Plots of the numeric predictor variables.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>q <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">01</span>, .<span class="dv">05</span>, .<span class="dv">1</span>, .<span class="dv">25</span>, .<span class="dv">5</span>, .<span class="dv">75</span>, .<span class="dv">9</span>, .<span class="dv">95</span>, .<span class="dv">99</span>, .<span class="dv">999</span>, <span class="dv">1</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>preds_numeric_quant <span class="ot">=</span> preds_numeric <span class="sc">|&gt;</span> <span class="fu">map</span>(\(x) {<span class="fu">quantile</span>(x, <span class="at">probs =</span> q)})</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>preds_numeric_quant <span class="ot">=</span> <span class="fu">do.call</span>(rbind, preds_numeric_quant)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  preds_numeric_quant, <span class="at">caption =</span> <span class="st">"Quantiles of numeric predictors."</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">3</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_paper</span>(<span class="st">"hover"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<table class="lightable-paper lightable-hover table table-sm table-striped small" data-quarto-postprocess="true">

<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">0%</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">1%</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">5%</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">10%</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">25%</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">50%</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">75%</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">90%</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">95%</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">99%</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">99.9%</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">100%</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">BonusMalus</td>
<td style="text-align: right;">50.000</td>
<td style="text-align: right;">50.00</td>
<td style="text-align: right;">50.00</td>
<td style="text-align: right;">50.00</td>
<td style="text-align: right;">50.00</td>
<td style="text-align: right;">55.00</td>
<td style="text-align: right;">76</td>
<td style="text-align: right;">95</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">125</td>
<td style="text-align: right;">156.000</td>
<td style="text-align: right;">228</td>
</tr>
<tr class="even">
<td style="text-align: left;">Density</td>
<td style="text-align: right;">2.000</td>
<td style="text-align: right;">10.00</td>
<td style="text-align: right;">24.00</td>
<td style="text-align: right;">41.00</td>
<td style="text-align: right;">111.00</td>
<td style="text-align: right;">495.00</td>
<td style="text-align: right;">2120</td>
<td style="text-align: right;">4348</td>
<td style="text-align: right;">8455</td>
<td style="text-align: right;">27000</td>
<td style="text-align: right;">27000.000</td>
<td style="text-align: right;">27000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DrivAge</td>
<td style="text-align: right;">18.000</td>
<td style="text-align: right;">19.00</td>
<td style="text-align: right;">23.00</td>
<td style="text-align: right;">26.00</td>
<td style="text-align: right;">34.00</td>
<td style="text-align: right;">45.00</td>
<td style="text-align: right;">54</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">81</td>
<td style="text-align: right;">89.000</td>
<td style="text-align: right;">99</td>
</tr>
<tr class="even">
<td style="text-align: left;">VehAge</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">30.000</td>
<td style="text-align: right;">99</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Exposure</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">0.21</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">0.76</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1.071</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>


<div class="quarto-table-caption margin-caption">Quantiles of numeric predictors.</div></div>
</div>
<p><em>Findings:</em></p>
<ul>
<li><code>BonusMalus</code>: heavily right-skewed, with almost half of the policies having the minimum value of 50, almost nothing &gt; 150</li>
<li><code>Density</code> heavily right-skewed, but larger share at <em>maximum</em> value (Paris?)</li>
<li><code>DrivAge</code>: right-skewed and cut-off at <em>age 18</em> (min driver age)</li>
<li><code>Exposure</code>: looks like mostly being full <em>one-year</em> data. Some outliers &gt; 1 and some shorter-periods.</li>
<li><code>VehAge</code>: heavily right-skewed, some outliers with values &gt; 30.</li>
</ul>
<p>We might need to remove some outliers and apply a <em>log-transformation</em>.</p>
</section>
<section id="ordinal-and-categorical-predictors" class="level6 page-columns page-full">
<h6 class="anchored" data-anchor-id="ordinal-and-categorical-predictors">Ordinal and categorical predictors</h6>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>preds_ord_cat <span class="ot">=</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(predictors<span class="sc">$</span>ordinal), <span class="fu">all_of</span>(predictors<span class="sc">$</span>categorical))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>preds_barchart <span class="ot">=</span> preds_ord_cat <span class="sc">|&gt;</span> </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.list</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(\(x) <span class="fu">tibble</span>(x) <span class="sc">|&gt;</span> <span class="fu">count</span>(x) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">x =</span> <span class="fu">as.character</span>(x))) <span class="sc">|&gt;</span> </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"name"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">x =</span> <span class="fu">factor</span>(x, <span class="at">levels =</span> x)) <span class="sc">|&gt;</span> </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n, <span class="at">y =</span> x)) <span class="sc">+</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"grey30"</span>) <span class="sc">+</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(name<span class="sc">~</span>., <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>preds_barchart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/eda-predictors-ord-cat-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="coding_challenge_files/figure-html/eda-predictors-ord-cat-1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">Barcharts with frequencies of the ordinal and categorical predictor variables.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>preds_ord_cat <span class="sc">|&gt;</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Area, <span class="at">y =</span> Region)) <span class="sc">+</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_count</span>(<span class="at">color =</span> <span class="st">"grey30"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/eda-predictors-area-region-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="coding_challenge_files/figure-html/eda-predictors-area-region-1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">Counts of policies in Region vs.&nbsp;Area.</figcaption>
</figure>
</div>
</div>
</div>
<p><em>Findings:</em></p>
<ul>
<li><code>Area</code>: most of the policies are in the <em>mid</em>-populated areas</li>
<li><code>Region</code> is not evenly distributed, with strong emphasis on four classes; in relationship to the <code>Area</code>, it looks like only <code>R11</code> contributes to the most densely populated <code>F</code>-Area. <code>R82</code> and <code>R93</code> have a similar pattern (with contributing most to <code>C</code>, <code>D</code>, and <code>E</code>).</li>
<li><code>VehBrand</code>: B1 and B2 seems to be the most popular brands in France; B12 is 3rd place.</li>
<li><code>VehGas</code>: evenly distributed, no differentiation</li>
<li><code>VehPower</code>: looks like <em>log-normally</em> distributed</li>
</ul>
<p>Maybe we can aggregate <code>Region</code> codes to less levels.</p>
</section>
</section>
<section id="correlation-analysis" class="level5 page-columns page-full">
<h5 class="anchored" data-anchor-id="correlation-analysis">Correlation Analysis</h5>
<p>First, check the relationships between some of the predictor variables.</p>
<p>To get a first impression, create a correlation matrix of the numeric (and ordinal) variables.</p>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>cor_mat <span class="ot">=</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(predictors<span class="sc">$</span>numeric), predictors<span class="sc">$</span>ordinal) <span class="sc">|&gt;</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.ordered), as.integer)) <span class="sc">|&gt;</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  corrr<span class="sc">::</span><span class="fu">correlate</span>() </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>cor_mat <span class="sc">|&gt;</span> </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  corrr<span class="sc">::</span><span class="fu">rearrange</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  corrr<span class="sc">::</span><span class="fu">shave</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  corrr<span class="sc">::</span><span class="fu">fashion</span>(<span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">digits =</span> <span class="dv">3</span>, <span class="at">caption =</span> <span class="st">"Pearson Correlations of numeric predictors."</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_paper</span>(<span class="st">"hover"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<table class="lightable-paper lightable-hover table table-sm table-striped small" data-quarto-postprocess="true">

<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">BonusMalus</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">VehAge</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Area</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Density</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">VehPower</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">DrivAge</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">BonusMalus</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">VehAge</td>
<td style="text-align: left;">.139</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Area</td>
<td style="text-align: left;">.085</td>
<td style="text-align: left;">-.071</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Density</td>
<td style="text-align: left;">.048</td>
<td style="text-align: left;">-.078</td>
<td style="text-align: left;">.593</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">VehPower</td>
<td style="text-align: left;">-.069</td>
<td style="text-align: left;">-.016</td>
<td style="text-align: left;">.019</td>
<td style="text-align: left;">.045</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">DrivAge</td>
<td style="text-align: left;">-.472</td>
<td style="text-align: left;">-.072</td>
<td style="text-align: left;">-.039</td>
<td style="text-align: left;">.002</td>
<td style="text-align: left;">.022</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>


<div class="quarto-table-caption margin-caption">Pearson Correlations of numeric predictors.</div></div>
</div>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>cor_mat <span class="sc">|&gt;</span> corrr<span class="sc">::</span><span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/cor-mat-plot-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="coding_challenge_files/figure-html/cor-mat-plot-1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">Correlation matrix plot of numeric (and ordinal) variables.</figcaption>
</figure>
</div>
</div>
</div>
<p>Some questions are:</p>
<ul>
<li>Is <code>Area</code> just an encoding for the <code>Density</code>?</li>
</ul>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Density, <span class="at">y =</span> Area)) <span class="sc">+</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">color =</span> <span class="st">"grey30"</span>) <span class="sc">+</span> </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/corr-dens-area-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="coding_challenge_files/figure-html/corr-dens-area-1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">Population density (on log10-transformed axis), splitted for different Area codes.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(dat, <span class="fu">cor</span>(<span class="fu">as.numeric</span>(Area), <span class="fu">log10</span>(Density)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9704985</code></pre>
</div>
</div>
<ul>
<li>How do the different variables (<code>Area</code>, <code>DrivAge</code>, <code>VehAge</code>, <code>VehPower</code>) relate to <code>BonusMalus</code></li>
</ul>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>p_area <span class="ot">=</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> BonusMalus, <span class="at">y =</span> Area)) <span class="sc">+</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">color =</span> <span class="st">"grey30"</span>) <span class="sc">+</span> </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>p_drivage <span class="ot">=</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">DrivAge =</span> <span class="fu">cut</span>(DrivAge, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">18</span>, <span class="fu">seq</span>(<span class="dv">20</span>, <span class="dv">100</span>, <span class="at">by =</span> <span class="dv">10</span>)), <span class="at">right =</span> <span class="cn">FALSE</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> BonusMalus, <span class="at">y =</span> DrivAge)) <span class="sc">+</span> </span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">color =</span> <span class="st">"grey30"</span>, <span class="at">varwidth =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>p_vehage <span class="ot">=</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">VehAge =</span> <span class="fu">cut</span>(VehAge, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="fu">seq</span>(<span class="dv">5</span>, <span class="dv">25</span>, <span class="at">by =</span> <span class="dv">5</span>), <span class="dv">100</span>), <span class="at">right =</span> <span class="cn">FALSE</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> BonusMalus, <span class="at">y =</span> VehAge)) <span class="sc">+</span> </span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">color =</span> <span class="st">"grey30"</span>, <span class="at">varwidth =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>p_vehpower <span class="ot">=</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> BonusMalus, <span class="at">y =</span> VehPower)) <span class="sc">+</span> </span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">color =</span> <span class="st">"grey30"</span>, <span class="at">varwidth =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>()</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>(p_area <span class="sc">/</span> p_drivage) <span class="sc">|</span> (p_vehage <span class="sc">/</span> p_vehpower)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/corr-bonusmalus-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="coding_challenge_files/figure-html/corr-bonusmalus-1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">BonusMalus (on log10-transformed axis), splitted for different levels of Area, DrivAge, VehAge, VehPower</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">BonusMalus =</span> <span class="fu">log10</span>(BonusMalus)) <span class="sc">|&gt;</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Area =</span> <span class="fu">as.numeric</span>(Area),</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">VehPower =</span> <span class="fu">as.numeric</span>(VehPower)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(BonusMalus, Area, DrivAge, VehAge, VehPower) <span class="sc">|&gt;</span> </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  corrr<span class="sc">::</span><span class="fu">correlate</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  corrr<span class="sc">::</span><span class="fu">focus</span>(BonusMalus)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  term     BonusMalus
  &lt;chr&gt;         &lt;dbl&gt;
1 Area         0.0901
2 DrivAge     -0.490 
3 VehAge       0.139 
4 VehPower    -0.0692</code></pre>
</div>
</div>
<p><em>Findings:</em></p>
<p>It looks like</p>
<ul>
<li><code>BonusMalus</code> differs in <code>Areas</code> <em>A, B, C</em> to <em>D, E, F</em>.</li>
<li><code>BonusMalus</code> is <em>strongly</em> negatively correlated to <code>DrivAge</code>. This implies, that <em>young drivers</em> need some time to get a bonus.</li>
<li>For <code>VehAge</code>, it looks like there is, on average, a higher bonus for <em>new cars</em>.</li>
</ul>
<p>Finally in EDA, check how well the <em>predictors correlate with the response</em></p>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>predictors <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Region"</span>, <span class="st">"Area"</span>, <span class="st">"Density"</span>, </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"BonusMalus"</span>, <span class="st">"DrivAge"</span>,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"VehAge"</span>, <span class="st">"VehPower"</span>, <span class="st">"VehGas"</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Exposure"</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>dat_pred_res <span class="ot">=</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ClaimAmountExposure, <span class="fu">all_of</span>(predictors))</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>dat_pred_res <span class="sc">|&gt;</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ClaimAmountExposure =</span> <span class="fu">log10</span>(ClaimAmountExposure)) <span class="sc">|&gt;</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">BonusMalus =</span> <span class="fu">log10</span>(BonusMalus)) <span class="sc">|&gt;</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Density =</span> <span class="fu">log10</span>(Density)) <span class="sc">|&gt;</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">c</span>(Area, VehPower), as.integer)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  corrr<span class="sc">::</span><span class="fu">correlate</span>() <span class="sc">|&gt;</span> </span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  corrr<span class="sc">::</span><span class="fu">focus</span>(ClaimAmountExposure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 2
  term       ClaimAmountExposure
  &lt;chr&gt;                    &lt;dbl&gt;
1 Area                   0.0402 
2 Density                0.0385 
3 BonusMalus             0.124  
4 DrivAge               -0.0690 
5 VehAge                -0.0232 
6 VehPower               0.00835
7 Exposure              -0.568  </code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># boxplots of claims</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>med <span class="ot">=</span> <span class="fu">median</span>(dat_pred_res<span class="sc">$</span>ClaimAmountExposure)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>dat_pred_res <span class="ot">=</span> dat_pred_res <span class="sc">|&gt;</span> </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Density =</span> <span class="fu">cut</span>(Density, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span><span class="sc">^</span>(<span class="fu">seq</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>))), <span class="at">right =</span> <span class="cn">FALSE</span>),</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">DrivAge =</span> <span class="fu">cut</span>(DrivAge, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">18</span>, <span class="dv">20</span>, <span class="dv">25</span>, <span class="fu">seq</span>(<span class="dv">30</span>, <span class="dv">100</span>, <span class="at">by =</span> <span class="dv">10</span>)), <span class="at">right =</span> <span class="cn">FALSE</span>),</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">VehAge =</span> <span class="fu">cut</span>(VehAge, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="fu">seq</span>(<span class="dv">5</span>, <span class="dv">25</span>, <span class="at">by =</span> <span class="dv">5</span>), <span class="dv">100</span>), <span class="at">right =</span> <span class="cn">FALSE</span>),</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">BonusMalus =</span> <span class="fu">cut</span>(BonusMalus, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="at">by =</span> <span class="dv">10</span>), <span class="dv">150</span>, <span class="dv">200</span>, <span class="dv">350</span>), <span class="at">right =</span> <span class="cn">FALSE</span>),</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Exposure =</span> <span class="fu">cut</span>(Exposure, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, .<span class="dv">25</span>), <span class="dv">3</span>), <span class="at">right =</span> <span class="cn">FALSE</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>plt_res <span class="ot">=</span> predictors <span class="sc">|&gt;</span> </span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    \(x) {</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>      dat_pred_res <span class="sc">|&gt;</span> </span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ClaimAmountExposure, <span class="at">y =</span> <span class="sc">!!</span><span class="fu">sym</span>(x))) <span class="sc">+</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_boxplot</span>(<span class="at">color =</span> <span class="st">"grey30"</span>) <span class="sc">+</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> med, <span class="at">col =</span> <span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_x_log10</span>()</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(plt_res, <span class="at">ncol =</span> <span class="dv">2</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/corr-pred-res-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="coding_challenge_files/figure-html/corr-pred-res-1.png" class="img-fluid figure-img" width="768"></a></p>
<figcaption class="figure-caption margin-caption">Correlation of predictors with response.</figcaption>
</figure>
</div>
</div>
</div>
<p><em>Findings:</em></p>
<ul>
<li>Regions <em>R23</em>, <em>R42</em>, and <em>R94</em> have higher values.</li>
<li>Values increase with <code>Area</code>/<code>Density</code></li>
<li>Positive correlation with <code>BonusMalus</code></li>
<li>Negative correlation with <code>DrivAge</code> (strongest deviation from median for age &lt; 20)</li>
<li><code>VehAge</code>: only new cars with higher values, Oldtimer with lower values (usually no day-to-day-use)</li>
<li>No correlation with <code>VehPower</code> and no differentiation for <code>VehGas</code></li>
<li>Strongest negative correlation with <code>Exposure</code>; seems like short running policies have a higher risk value.</li>
</ul>
</section>
</section>
</section>
<section id="modeling" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="modeling">Modeling</h3>
<p>For model training and comparison, we (mostly) follow the approach as described in <a href="https://www.tmwr.org">Tidy Modeling with R</a></p>
<section id="feature-engineering" class="level4">
<h4 class="anchored" data-anchor-id="feature-engineering">Feature Engineering</h4>
<p>Based on our findings in EDA, we want to apply these modifications to the data set for modeling:</p>
<ul>
<li>remove below 1% (~53)/ above 99% (~111k) from data and log-transform response</li>
<li>drop <code>Area</code> (as heavily auto-correlated with <code>Density</code>)</li>
<li>log-transform <code>Density</code></li>
<li>remove outliers WRT <code>BonusMalus</code> (&gt; 99.9%; 156) and log-transform</li>
<li>remove outliers WRT <code>VehAge</code> (&gt; 99.9%; 30) and log-transform</li>
<li>log-transform <code>VehPower</code></li>
<li>drop <code>VehGas</code> as no explanatory power</li>
<li>remove <code>Exposure</code> values &gt; 1 and categorize ([0,.25), [.25,.75), [.75, 1), [1])</li>
</ul>
<p>Additionally, depending on the selected model, we might need to <em>dummify</em> the categorical variables (this happens in the workflow setup).</p>
<p>Most of the feature engineering happens within the workflow setup (see later).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>qnt <span class="ot">=</span> <span class="fu">quantile</span>(dat<span class="sc">$</span>ClaimAmountExposure, <span class="fu">c</span>(.<span class="dv">01</span>, .<span class="dv">99</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">=</span> dat <span class="sc">|&gt;</span> </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(ClaimAmountExposure, qnt[<span class="dv">1</span>], qnt[<span class="dv">2</span>])</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">ClaimAmountExposure =</span> base<span class="sc">::</span><span class="fu">log10</span>(ClaimAmountExposure)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">=</span> mod <span class="sc">|&gt;</span> </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Area, <span class="sc">-</span>VehGas) <span class="sc">|&gt;</span> </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    BonusMalus <span class="sc">&lt;</span> <span class="fu">quantile</span>(BonusMalus, .<span class="dv">999</span>),</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    VehAge <span class="sc">&lt;</span> <span class="fu">quantile</span>(VehAge, .<span class="dv">999</span>),</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    Exposure <span class="sc">&lt;=</span> <span class="dv">1</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">Density =</span> <span class="fu">log10</span>(Density),</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">BonusMalus =</span> <span class="fu">log10</span>(BonusMalus),</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">VehAge =</span> <span class="fu">log10</span>(VehAge <span class="sc">+</span> <span class="dv">10</span>),</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">VehPower =</span> <span class="fu">log10</span>(<span class="fu">as.integer</span>(VehPower)),</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">Exposure =</span> <span class="fu">case_when</span>(</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>      Exposure <span class="sc">&lt;</span> .<span class="dv">25</span> <span class="sc">~</span> 1L,</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>      Exposure <span class="sc">&lt;</span> .<span class="dv">75</span> <span class="sc">~</span> 2L,</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>      Exposure <span class="sc">&lt;</span> <span class="dv">1</span> <span class="sc">~</span> 3L,</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> 4L</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>  ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="model-training" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="model-training">Model Training</h4>
<p>For model training and evaluation, we follow the approach of an initial split (80% train, 20% test), and a repeated cross-validation within the training data set for model comparison.</p>
<p>We use a stratified sampling WRT the response to make sure that both groups are similar WRT the distribution of the response variable.</p>
<section id="data-splitting" class="level5">
<h5 class="anchored" data-anchor-id="data-splitting">Data Splitting</h5>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set seed for reproducability</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2021</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># initials split of data into 80/20</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>(<span class="at">mod_split =</span> <span class="fu">validation_split</span>(mod, <span class="at">prop =</span> <span class="fl">0.80</span>, <span class="at">strata =</span> ClaimAmountExposure))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  splits               id        
  &lt;list&gt;               &lt;chr&gt;     
1 &lt;split [19460/4868]&gt; validation</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>mod_train <span class="ot">=</span> <span class="fu">training</span>(mod_split<span class="sc">$</span>splits[[<span class="dv">1</span>]])</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>mod_test <span class="ot">=</span> <span class="fu">testing</span>(mod_split<span class="sc">$</span>splits[[<span class="dv">1</span>]])</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># split train into folds for cv (5x repeated 10-fold cv)</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># mod_cv_folds = vfold_cv(mod_train, v = 5, strata = ClaimAmountExposure)</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>mod_cv_folds <span class="ot">=</span> <span class="fu">vfold_cv</span>(mod_train, <span class="at">v =</span> <span class="dv">10</span>, <span class="at">repeats =</span> <span class="dv">5</span>, <span class="at">strata =</span> ClaimAmountExposure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="model-fitting-and-comparison" class="level5 page-columns page-full">
<h5 class="anchored" data-anchor-id="model-fitting-and-comparison">Model Fitting and Comparison</h5>
<p>Let’s start with three different modeling approaches: - GLM - RandomForest - XGBoost</p>
<p>For now, we do not apply any hyper-parameter tuning (we use the default settings of the algorithms).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define a recipe for data preparation</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>basic_rec <span class="ot">=</span> <span class="fu">recipe</span>(</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  ClaimAmountExposure <span class="sc">~</span> Region <span class="sc">+</span> Density <span class="sc">+</span> DrivAge <span class="sc">+</span> BonusMalus <span class="sc">+</span> VehPower <span class="sc">+</span> VehAge <span class="sc">+</span> VehBrand <span class="sc">+</span> Exposure, </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mod</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co"># additionally for lm/xgboost</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>dummy_rec <span class="ot">=</span> basic_rec <span class="sc">|&gt;</span> </span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>onehot_rec <span class="ot">=</span> basic_rec <span class="sc">|&gt;</span> </span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>(), <span class="at">one_hot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co"># define the modeling workflow</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>mod_wflow <span class="ot">=</span> <span class="fu">workflow_set</span>(</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">preproc =</span> <span class="fu">list</span>(</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">dummy =</span> dummy_rec,</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">basic =</span> basic_rec,</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">onehot =</span> onehot_rec</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    ), </span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">list</span>(</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">lm =</span> <span class="fu">linear_reg</span>(<span class="at">engine =</span> <span class="st">"glm"</span>),</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">rf =</span> <span class="fu">rand_forest</span>(<span class="at">mode =</span> <span class="st">"regression"</span>),</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">xgb =</span> <span class="fu">boost_tree</span>(<span class="at">mode =</span> <span class="st">"regression"</span>)</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">cross =</span> <span class="cn">FALSE</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Run the model fit in cross-validation mode:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define resampling</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>keep_pred <span class="ot">=</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>, <span class="at">save_workflow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># execute model-training in CV mode</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>mod_wflow_cv <span class="ot">=</span> mod_wflow <span class="sc">|&gt;</span> </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_map</span>(</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fit_resamples"</span>,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">2021</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>, </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> mod_cv_folds, <span class="at">control =</span> keep_pred</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>i 1 of 3 resampling: dummy_lm</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ 1 of 3 resampling: dummy_lm (8s)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i 2 of 3 resampling: basic_rf</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ 2 of 3 resampling: basic_rf (4m 34s)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i 3 of 3 resampling: onehot_xgb</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ 3 of 3 resampling: onehot_xgb (24.1s)</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>mod_wflow_cv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  wflow_id   info             option    result   
  &lt;chr&gt;      &lt;list&gt;           &lt;list&gt;    &lt;list&gt;   
1 dummy_lm   &lt;tibble [1 × 4]&gt; &lt;opts[2]&gt; &lt;rsmp[+]&gt;
2 basic_rf   &lt;tibble [1 × 4]&gt; &lt;opts[2]&gt; &lt;rsmp[+]&gt;
3 onehot_xgb &lt;tibble [1 × 4]&gt; &lt;opts[2]&gt; &lt;rsmp[+]&gt;</code></pre>
</div>
</div>
<p>For comparing the models WRT to performance, we evaluate the errors in cross-validation mode.</p>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the metrics</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>cv_ranks <span class="ot">=</span> workflowsets<span class="sc">::</span><span class="fu">rank_results</span>(</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  mod_wflow_cv, <span class="at">rank_metric =</span> <span class="st">"rmse"</span>, <span class="at">select_best =</span> <span class="cn">TRUE</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(wflow_id, model, .metric, mean, rank) </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>cv_ranks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  wflow_id   model       .metric  mean  rank
  &lt;chr&gt;      &lt;chr&gt;       &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt;
1 onehot_xgb boost_tree  rmse    0.457     1
2 onehot_xgb boost_tree  rsq     0.311     1
3 basic_rf   rand_forest rmse    0.461     2
4 basic_rf   rand_forest rsq     0.297     2
5 dummy_lm   linear_reg  rmse    0.467     3
6 dummy_lm   linear_reg  rsq     0.277     3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the metrics with confidence intervals</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(mod_wflow_cv) <span class="sc">+</span> </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  colorspace<span class="sc">::</span><span class="fu">scale_color_discrete_sequential</span>(<span class="at">palette =</span> <span class="st">"viridis"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/mod-eval-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="coding_challenge_files/figure-html/mod-eval-1-1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">Confidence intervals for RMSE and R² using different models during Cross Validation.</figcaption>
</figure>
</div>
</div>
</div>
<p>Both RMSE and R² show the same order with regards to model performance.</p>
<p>It looks like XGBoost slightly outperforms random forest, both being better than the GLM.</p>
<p>In general, all three show a very large error spread.</p>
<p>Let’s have a look at the cross-validated predictions.</p>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># access the predictions across the cv</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>cv_res <span class="ot">=</span> <span class="fu">collect_predictions</span>(mod_wflow_cv, <span class="at">summarize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co"># compute values in original scale</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>cv_res_orig <span class="ot">=</span> cv_res <span class="sc">|&gt;</span> </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(ClaimAmountExposure, .pred), \(x) <span class="dv">10</span><span class="sc">^</span>x))</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="co"># plot obs-vs-pred</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>p_log <span class="ot">=</span> cv_res <span class="sc">%&gt;%</span> </span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ClaimAmountExposure, <span class="at">y =</span> .pred)) <span class="sc">+</span> </span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_point(alpha = .15) +</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hex</span>(<span class="at">binwidth =</span> .<span class="dv">25</span>) <span class="sc">+</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">color =</span> <span class="st">"orange"</span>) <span class="sc">+</span> </span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linewidth =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>  colorspace<span class="sc">::</span><span class="fu">scale_fill_continuous_sequential</span>(<span class="at">palette =</span> <span class="st">"viridis"</span>) <span class="sc">+</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_obs_pred</span>() <span class="sc">+</span> </span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Predicted"</span>) <span class="sc">+</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>wflow_id)</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="co"># plot obs-vs-pred</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>p_orig <span class="ot">=</span> cv_res_orig <span class="sc">%&gt;%</span> </span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ClaimAmountExposure, <span class="at">y =</span> .pred)) <span class="sc">+</span> </span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> .<span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">color =</span> <span class="st">"orange"</span>) <span class="sc">+</span> </span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linewidth =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_obs_pred</span>() <span class="sc">+</span> </span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Predicted"</span>) <span class="sc">+</span> </span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>wflow_id)</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>p_log <span class="sc">/</span> p_orig <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"a"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/mod-eval-2-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="coding_challenge_files/figure-html/mod-eval-2-1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">Out-of-sample obs-vs-pred values. (a) using the log-10 units as predicted. (b) back-transformed to the original values.</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="model-building" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="model-building">Model building</h4>
<p>Finally, retrain the all models on the entire train data and predict on the non-seen test data.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># train the models on the total train set</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>mod_wflow_test <span class="ot">=</span> mod_wflow <span class="sc">|&gt;</span> </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">workflow_map</span>(</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fit_resamples"</span>,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">2021</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>, </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> mod_split, <span class="at">control =</span> keep_pred</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>i 1 of 3 resampling: dummy_lm</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ 1 of 3 resampling: dummy_lm (230ms)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i 2 of 3 resampling: basic_rf</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ 2 of 3 resampling: basic_rf (6s)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i 3 of 3 resampling: onehot_xgb</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ 3 of 3 resampling: onehot_xgb (622ms)</code></pre>
</div>
</div>
<p>Let’s extract the metrics and compare them with the ones from the cross-validation. Ideally, these should be similar, indicating that we didn’t get too optimistic values in cross-validation.</p>
<div class="cell page-columns page-full">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the metrics</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>test_ranks <span class="ot">=</span> workflowsets<span class="sc">::</span><span class="fu">rank_results</span>(</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  mod_wflow_test, <span class="at">rank_metric =</span> <span class="st">"rmse"</span>, <span class="at">select_best =</span> <span class="cn">TRUE</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(wflow_id, model, .metric, mean, rank)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="co"># compare to cv-metrics</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>metrics <span class="ot">=</span> <span class="fu">inner_join</span>(</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  cv_ranks, test_ranks, </span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"wflow_id"</span>, <span class="st">"model"</span>, <span class="st">".metric"</span>),</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">".cv"</span>, <span class="st">".test"</span>)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>kableExtra<span class="sc">::</span><span class="fu">kbl</span>(metrics,  <span class="at">caption =</span> <span class="st">"Performance metrics both for CV and test holdout."</span>) <span class="sc">|&gt;</span> </span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_paper</span>(<span class="st">"hover"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<table class="lightable-paper lightable-hover table table-sm table-striped small" data-quarto-postprocess="true">

<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">wflow_id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">model</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">.metric</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean.cv</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rank.cv</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean.test</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rank.test</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">onehot_xgb</td>
<td style="text-align: left;">boost_tree</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">0.4568538</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.4608431</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">onehot_xgb</td>
<td style="text-align: left;">boost_tree</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">0.3105173</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.3131625</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">basic_rf</td>
<td style="text-align: left;">rand_forest</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">0.4611224</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.4645975</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">basic_rf</td>
<td style="text-align: left;">rand_forest</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">0.2974373</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.3019125</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dummy_lm</td>
<td style="text-align: left;">linear_reg</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">0.4674933</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.4737914</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">dummy_lm</td>
<td style="text-align: left;">linear_reg</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">0.2773812</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.2734354</td>
<td style="text-align: right;">3</td>
</tr>
</tbody>
</table>


<div class="quarto-table-caption margin-caption">Performance metrics both for CV and test holdout.</div></div>
</div>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># access the predictions on the final test set</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>test_res <span class="ot">=</span> <span class="fu">collect_predictions</span>(mod_wflow_cv, <span class="at">summarize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co"># compute values in original scale</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>test_res_orig <span class="ot">=</span> test_res <span class="sc">|&gt;</span> </span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(ClaimAmountExposure, .pred), \(x) <span class="dv">10</span><span class="sc">^</span>x))</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="co"># plot obs-vs-pred</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>p_log <span class="ot">=</span> test_res <span class="sc">%&gt;%</span> </span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ClaimAmountExposure, <span class="at">y =</span> .pred)) <span class="sc">+</span> </span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_point(alpha = .15) +</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hex</span>(<span class="at">binwidth =</span> .<span class="dv">25</span>) <span class="sc">+</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">color =</span> <span class="st">"orange"</span>) <span class="sc">+</span> </span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linewidth =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>  colorspace<span class="sc">::</span><span class="fu">scale_fill_continuous_sequential</span>(<span class="at">palette =</span> <span class="st">"viridis"</span>) <span class="sc">+</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_obs_pred</span>() <span class="sc">+</span> </span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Predicted"</span>) <span class="sc">+</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>wflow_id)</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a><span class="co"># plot obs-vs-pred</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>p_orig <span class="ot">=</span> test_res_orig <span class="sc">%&gt;%</span> </span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ClaimAmountExposure, <span class="at">y =</span> .pred)) <span class="sc">+</span> </span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> .<span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">color =</span> <span class="st">"orange"</span>) <span class="sc">+</span> </span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linewidth =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_obs_pred</span>() <span class="sc">+</span> </span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Predicted"</span>) <span class="sc">+</span> </span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>wflow_id)</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>p_log <span class="sc">/</span> p_orig <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"a"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/mod-build-obs-pred-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="coding_challenge_files/figure-html/mod-build-obs-pred-1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">Test obs-vs-pred values. (a) using the log-10 units as predicted. (b) back-transformed to the original values.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="model-explanations-variable-importance" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="model-explanations-variable-importance">Model explanations / Variable importance</h4>
<p>Let’s have a deeper look into the models and their coefficients / variables importance.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>models <span class="ot">=</span> mod_wflow<span class="sc">$</span>wflow_id <span class="sc">|&gt;</span> </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    \(x) {</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>      mod_wflow <span class="sc">|&gt;</span> </span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">extract_workflow</span>(x) <span class="sc">|&gt;</span> </span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fit</span>(mod_train) </span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>First, check the coefficients of the linear model</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>dummy_lm <span class="ot">=</span> models<span class="sc">$</span>dummy_lm <span class="sc">|&gt;</span> </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_engine</span>() </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>coeff <span class="ot">=</span> <span class="fu">coefficients</span>(dummy_lm) <span class="sc">|&gt;</span> </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>() <span class="sc">|&gt;</span> </span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">abs =</span> <span class="fu">abs</span>(value)) <span class="sc">|&gt;</span> </span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(abs))</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>coeff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 38 × 3
   name           value    abs
   &lt;chr&gt;          &lt;dbl&gt;  &lt;dbl&gt;
 1 (Intercept)   3.15   3.15  
 2 BonusMalus    0.407  0.407 
 3 Exposure     -0.271  0.271 
 4 Region_R43    0.158  0.158 
 5 Region_R94    0.117  0.117 
 6 Region_R83   -0.0680 0.0680
 7 Region_R21   -0.0664 0.0664
 8 Region_R41    0.0647 0.0647
 9 VehBrand_B11 -0.0548 0.0548
10 Region_R72    0.0474 0.0474
# ℹ 28 more rows</code></pre>
</div>
</div>
<p>For the XGBoost model, extract the variable importances.</p>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>models<span class="sc">$</span>onehot_xgb <span class="sc">|&gt;</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">|&gt;</span> </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vip</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display page-columns page-full">
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="coding_challenge_files/figure-html/mod-xgboost-vip--1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="coding_challenge_files/figure-html/mod-xgboost-vip--1.png" class="img-fluid figure-img" width="672"></a></p>
<figcaption class="figure-caption margin-caption">Variable importance plot for the XGBoost model.</figcaption>
</figure>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb = models$onehot_xgb |&gt; </span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   extract_model() </span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># xgboost::xgb.plot.tree(model = xgb, trees = 0:1)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="model-selection" class="level4">
<h4 class="anchored" data-anchor-id="model-selection">Model selection</h4>
<p>Based on the <em>RMSE</em> and the <em>R²</em>, we’d select the XGBoost algorithm for now. Nonetheless, as the <em>pred-vs-obs</em> plots show, the linear model might be best when focusing on the most frequent values of the response.</p>
</section>
<section id="model-optimizations" class="level4">
<h4 class="anchored" data-anchor-id="model-optimizations">Model optimizations</h4>
<p>Different improvement steps could be:</p>
<ul>
<li>Further feature engineering, e.g.&nbsp;a better categorization to some variables (e.g.&nbsp;<code>DrivAge</code>) to emphasis more on relevant pattern.</li>
<li>We did not apply any hyper-parameter tuning for the tree-based modeling approaches in this study. Tuning these might help to find the optimal combinations.</li>
<li>Further models (like deep neural nets, etc.) and ensemble models can be tested.</li>
</ul>
</section>
</section>
</section>
<section id="discussion-and-outlook" class="level2">
<h2 class="anchored" data-anchor-id="discussion-and-outlook">Discussion and Outlook</h2>
<p>In this study, we included the <code>Exposure</code> as additional explanatory variable.</p>
<p>It might hint at short-term policies (e.g.&nbsp;car rental, leasing) vs.&nbsp;regular policies. This might be useful for calculating fare rates, if the insurance company knows in advance, which kind of contract (short vs.&nbsp;unlimited) it is. Then the predictor variable would most likely be a boolean category.</p>
<p>Here, we focused on modeling the <em>expected amount of damage</em>.</p>
<p>To get to the a fair insurance contribution for each policy, we need to assess the second aspect of the overall “risk” as well: the <em>probability of occurrence</em> for causing a damage.</p>
<p>This could be approached, e.g.&nbsp;using a logistic regression model.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"loop":true,"closeEffect":"zoom","openEffect":"zoom","selector":".lightbox","descPosition":"bottom"});</script>



</body></html>